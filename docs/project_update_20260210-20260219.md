# 20260210 - 20260219 Updates
Made a significant number of changes over the last nine days but did not push updates due to timing constraints and general life scheduling.

This consolidates all configuration changes, architectural corrections, hardening updates, and validation scripting performed during that period.

---

## Architectural Correction – Boundary Device Replacement

Root cause analysis determined that the **Netgear R7000 (AC1900)** running OpenWrt was introducing instability due to Broadcom chipset limitations and incomplete support within modern OpenWrt DSA architecture.

Observed issues:

* Bridge/port mapping inconsistencies
* Port 4 not correctly binding to br-lab
* DHCP leaking from 192.168.1.1 instead of 192.168.20.1
* Inconsistent L2 forwarding behavior
* br-lan / br-lab overlapping behavior
* Physical port numbering mismatch vs LuCI representation

Confirmed:

* Not firewall related
* Not DHCP server failure
* Not routing misconfiguration
* Layer 2 association failure at bridge level

Conclusion:
Broadcom hardware support limitations were the underlying constraint.

Action Taken:

* R7000 removed from topology
* Flashed **TP-Link Archer A7 (AC1750 v5.0)** with OpenWrt
* Rebuilt segmentation model cleanly

---

## Current Boundary Architecture

Primary Router:
TP-Link Archer AXE95
192.168.1.1/24

Boundary Firewall:
TP-Link Archer A7 (OpenWrt)

* WAN: 192.168.1.2
* LAN: 192.168.20.1/24

Lab Subnet:
192.168.20.0/24

Isolation Model:

* No direct Home LAN → Lab access
* Bastion-mediated administrative entry
* No uncontrolled egress
* Explicit deny posture

---

## Updated Network Topology

```
Admin Laptop (192.168.1.x)
        ↓
AXE95 (192.168.1.1)
        ↓
Archer A7 (OpenWrt)
WAN: 192.168.1.2
LAN: 192.168.20.1
        ↓
TL-SG106PME (Lab Switch)
        ↓
pi5-bastion-01 (192.168.20.10)
        ↓
k3s Cluster Nodes
```

No more br-lan/br-lab ambiguity.

Clean L3 segmentation.

---

## Lab Node Standardization

Finalized hostname convention:

| Hostname       | IP            | Role              |
| -------------- | ------------- | ----------------- |
| pi5-bastion-01 | 192.168.20.10 | SSH Gateway       |
| pi5-ctrl-01    | 192.168.20.11 | k3s Control Plane |
| pi5-worker-01  | 192.168.20.21 | k3s Agent         |
| pi5-worker-02  | 192.168.20.22 | k3s Agent         |
| pi5-worker-03  | 192.168.20.23 | k3s Agent         |
| pi4-rancher-01 | 192.168.20.30 | Rancher           |

All static addressing.

All `/etc/hosts` updated cluster-wide.

---

## Bastion Host Hardening

pi5-bastion-01 now configured as:

* Static IP
* SSH key-based auth only
* PasswordAuthentication disabled
* PermitRootLogin disabled
* IP forwarding disabled
* fail2ban enabled
* auditd enabled
* No container workloads
* kubeconfig stored locally
* No direct control plane exposure to Home LAN

Administrative flow enforced as:

```
Home LAN → Bastion → Cluster
```

No direct Home LAN → pi5-ctrl-01 communication permitted.

---

## OpenWrt Firewall Model (Archer A7)

Zone Model:

LAN (Lab):

* Input: REJECT
* Forward: REJECT

WAN (Home LAN side):

* Input: REJECT
* Forward: REJECT

Explicit Rule:

* Allow TCP/22 from 192.168.1.0/24 → 192.168.20.10 only

Blocked:

* Home LAN → Any other 192.168.20.x host
* Lab → Home LAN
* Lab → Internet (true enclave mode)

Logging enabled for dropped/rejected packets.

Verified via scripted testing (below).

---

## k3s Cluster Validation

Control Plane:
pi5-ctrl-01 (192.168.20.11)

Workers:
pi5-worker-01/02/03

Confirmed:

* Nodes join successfully
* kubectl functional from bastion
* API (6443) unreachable from Home LAN
* SSH reachable only via bastion

Control plane taint applied.

Cluster fully contained within enclave.

---

## Hardening Verification Scripts Implemented

Created Python validation scripts to programmatically confirm enforcement posture:

1. Home LAN reachability matrix

   * Verifies only 192.168.20.10:22 reachable
   * Confirms all other ports blocked

2. SSH banner validation

   * Ensures actual SSH daemon reachable on bastion only

3. Bastion → cluster internal connectivity

   * Confirms east-west traffic allowed only where required

4. Lab → Home LAN egress test

   * Verifies no outbound routing permitted

5. Bastion self-audit script

   * Verifies:

     * PasswordAuthentication=no
     * PermitRootLogin disabled
     * IP forwarding disabled
     * fail2ban active
     * auditd active

All scripts produce PASS/FAIL output for quick validation.

---

## NVMe + Pi5 Standardization

All Pi5 nodes:

* PCIe enabled
* NVMe detected via lspci
* Boot order set to NVMe
* cgroup_memory and cgroup_enable configured
* Confirmed via `/proc/cmdline`

USB boot abandoned due to unacceptable latency.

---

## Key Lessons Learned

* Broadcom chipsets are not ideal for OpenWrt lab segmentation builds.
* DSA bridge models must be mapped carefully against physical port numbering.
* DHCP behavior leaking from upstream is a clear indicator of L2 misassociation.
* Replacing unstable hardware was faster than forcing partial functionality.
* Explicit deny model is easier to validate than permissive plus filters.

---

## Current State Summary

* Dual-router segmentation functional
* Archer A7 stable and enforcing boundary
* Bastion hardened
* k3s cluster contained
* No direct IT → OT path
* No uncontrolled egress
* All validation scripts passing

Architecture now clean, defensible, and demonstrable.

---

## Next Steps

* VLAN internal separation (Mgmt vs Workload plane)
* Centralized log aggregation
* MFA on bastion SSH
* NetworkPolicy enforcement in k3s
* Diagram refresh and upload
* Final config snapshot archival
